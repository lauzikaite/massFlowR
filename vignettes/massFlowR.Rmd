---
title: "Introduction to massFlowR package"
output:
  BiocStyle::html_document:
    toc_float: true
    collapsed: false
vignette: >
  %\VignetteIndexEntry{Introduction to massFlowR package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignettePackage{massFlowR}
  %\VignetteKeywords{mass spectrometry, metabolomics}
---

**Package**: [massFlowR](https://github.com/lauzikaite/massFlowR)<br />
**Authors**: Elzbieta Lauzikaite<br />
**Modified**: `r file.info("massFloWR.Rmd")$mtime`<br />
**Compiled**: `r date()`

```{r  setup, echo = FALSE, results = "asis" }
BiocStyle::markdown() 
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
Biocpkg <- function (pkg) {
    sprintf("[%s](http://bioconductor.org/packages/%s)", pkg, pkg)
}
options(kpb.suppress_noninteractive = TRUE) ## supressing progress bar
```

```{r libraries, message = FALSE, echo = FALSE}
## load libraries quietly to avoid printing messages in the vignette
suppressWarnings(library(massFlowR))
suppressWarnings(library(xcms))
suppressWarnings(library(dplyr))
```

# Overview

This documents provides an overview of the LC-MS data pre-processing with `massFlowR`.

`massFlowR` aligns and annotates structurally-related spectral peaks across LC-MS experiment samples. The pipeline consists of three stages:

* [Processing of individual LC-MS samples](#individual-samples-processing)
* [Peak alignment across samples](#peak-alignment)
    * [Automatic peak annotation](#peak-annotation)
* [Alignment validation](#alignment-validation)

# Installation

Install the development version of the package directly from GitHub with:

```{r  installation, eval = FALSE }
if (!require("devtools")) install.packages("devtools")
devtools::install_github("lauzikaite/massflowR")
```

# Data import

LC-MS data in mzML/NetCDF format import is supported. Data import is implemented via `r Biocpkg("mzR")` package.

In this document, functionality of the package will be demonstrated using data from `r Biocpkg("faahKO")` package. Raw LC-MS data files (in NetCDF format) are provided for spinal cords samples taken from six knock-out (KO) and six wild-type (WT) mice. Each datafile contains centroided data acquired in positive ionization mode, with data recorded at 200-600 m/z and 2500-4500 seconds.

Load the package and locate the raw CDF files within the `faahKO` package:

```{r  data_import}
library(massFlowR)
## Get the full path to the CDF files
# faahKO_files <- system.file(c('cdf/WT/wt15.CDF', 'cdf/WT/wt16.CDF'), package = "faahKO")
faahKO_files <- dir(system.file("cdf/WT", package = "faahKO"), full.names = T)
faahKO_files
```

# Individual samples processing

The first stage in the pipeline is chromatographic peak detection and peak grouping via function `groupPEAKS`.

## Chromatographic peak detection

Peaks are detected using the *centWave* algorithm from `r Biocpkg("xcms")` package. Appropriate parameters for the LC-MS experiment must be selected. For advise on this, please see the official `xcms` [manual](https://bioconductor.org/packages/release/bioc/vignettes/xcms/inst/doc/xcms.html#3_initial_data_inspection). Selected parameters must be built into a *CentWaveParam* class object:

```{r params}
## xcms parameters for peak-picking
cwt_param <- xcms::CentWaveParam(ppm = 25,
                                 snthresh = 10,
                                 noise = 1000,
                                 prefilter =  c(3, 100),
                                 peakwidth = c(30, 80))
```

## Chromatographic peak grouping

Detected peaks are grouped into *pseudo chemical spectra* (PCS), which comprise peaks originating from the same chemical compound: adducts and isotopes. For each peak in a sample, function `groupPEAKS`:

* Finds all co-eluting peaks
* Performs extracted ion chromatogram (EIC) correlation between all co-eluting peaks
* Builds a network of peaks with high EIC correlation

Peaks in the resulting network form a single PCS. Only PCSs with more than one peak are retained in the final peak table and corresponding csv file.

## Implementation

Function `groupPEAKS` processes every LC-MS datafile independently and thus can be implemented in parallel, or during sample acquisition on the machine linked to the LC-MS. A list of paths to LC-MS datafiles (in mzML/NetCDF format) is feeded to `groupPEAKS`, together with the *CentWaveParam* class object, path to output directory and parameters for parallelisation. 

`groupPEAKS` writes a csv with detected and grouped peaks in the selected directory for each LC-MS sample separately. The filenames of the generated csv files will be needed for the next stage in the pipeline. The filename starts with the original raw LC-MS filename and ends with "peakgrs.csv".

```{r peak_grouping}
## define where processed datafiles should be written
out_directory <- getwd()

## define multi-core processing 
bpparam_params <- BiocParallel::MulticoreParam(workers = 2)

## run peak detection and grouping for the listed faahKO files with two workers
groupPEAKS(files = faahKO_files, out_dir = out_directory, cwt = cwt_param, bpparam = bpparam_params)
```

# Peak alignment

To align peaks across samples in LC-MS experiment, an alignment algorithm, which preserves the structural spectral information, is implemented. 

Peaks are aligned by taking samples in the order of raw sample acquisition and matching them against a template. Template is list of all previously aligned peaks, which is updated with each sample by:

* adding new peaks
* averaging the *m/z* and *rt* values of matching peaks between the sample and the template.

Therefore, template stores the **moving averages** of *m/z* and *rt* values. 

For each peak in a sample, alignment algorithm:

1. Finds all template peaks within a *m/z* and *rt* window.
2. Identifies the true match by comparing the spectral similarity between the PCS of the peak-of-interest and all matching template's PCSs.
3. Merges the selected template's peak-group with the peak-group of the peak-of-interest. It updates template's *m/z* and *rt*  values for the matching peaks across the template and the sample.

Spectral similarity is measured by obtaining the cosine of the angle between two 2D vectors, representing each PCSs *m/z* and *intensity* values.

## Implementation

To enable peak alignment, firstly create a csv file with as many rows as there are samples in the experiment. File must contain the following columns for each sample:

* `filepaths` specifies the absolute path to a csv file, generated by the `groupPEAKS` function.
* `run_order` specifies the acquisition order for the corresponding LC-MS sample.

```{r experiment_table_build}
## create a csv file, which lists all samples in your experiment and their run order
processed_files <- list.files(out_directory, "peakgrs.csv", full.names = T)
experiment_table <- data.frame(filepaths = processed_files, run_order = 1:length(faahKO_files), stringsAsFactors = F)
write.csv(experiment_table, file.path(out_directory, "experiment.csv"), row.names = F)
```

```{r experiment_table, echo = FALSE}
knitr::kable(x = experiment_table,
             format = "html",
             row.names = F) %>% 
  kableExtra::kable_styling(full_width = TRUE, bootstrap_options = "striped", position = "left")
```

To initiate peak alignment, use function `buildTMP`, which constructs a `massFlowTemplate`class object. `massFlowTemplate` object stores sample alignment and annotation data and is updated with every sample. Define the desired error window for *m/z* and *rt* (seconds) values, which will be used for the whole experiment. `mz_err = 0.01` and `rt_err = 2` are recommended for high-resolution UPLC-MS data. `mz_err = 0.01` and `rt_err = 10` are suitable for the `faahKO`package data.

```{r buildTMP}
## initiate template
template <- buildTMP(file = file.path(out_directory, "experiment.csv"), mz_err = 0.01, rt_err = 10)
```

`massFlowTemplate` object stores the most up-to-date template within the `@tmp` slot. Function `buildTMP` creates a template using the first sample in the experiment. To review the samples that are in the experiment, use slot `@samples`.

```{r massFlowTemplate}
## review gnerated template using slot "tmp"
head(template@tmp)

## review samples in the experiment using slot "samples"
template@samples
```

To align peaks across all samples in the study, apply method `alignPEAKS`. `alignPEAKS` updates the `massFlowTemplate` object:

1. Selects next sample to be aligned and checks whether it was already peak-picked and grouped (waits until the corresponding csv file is written).
2. Matches every peak in the sample against the template.
3. Selects best matches using spectral similarity comparison.
3. Updates template with sample's peaks: adds new and averages matching peaks.

```{r alignPEAKS}
## align peaks across all remaining samples
template <- alignPEAKS(template)
```

Aligned sample's peak tables are stored within the `@data` slot, which lists tables for each sample separately.

```{r data_slot, eval = FALSE}
## review alignment results for an individual sample, e.g. the second, using slot "data"
head(template@data[[2]])
```

```{r data_slot_knitr, echo = FALSE}
## review alignment results for an individual sample, e.g. the second, using slot "data"
dt <- head(template@data[[2]])
knitr::kable(x = dt,
             format = "html",
             row.names = F) %>% 
  kableExtra::kable_styling(full_width = TRUE, bootstrap_options = c("striped"), position = "left")
```

# Peak annotation

If in-house chemical reference database is available, peaks are automatically annotated during sample alignment. For more details how to build a database file, see [annotation using database](http://htmlpreview.github.io/?https://github.com/lauzikaite/massFlowR/blob/master/inst/doc/annotation.html))).

To enable peak annotation during sample alignment, first a `massFlowDB` class object must be built.

```{r buildDB}
## define path to the database file, use the sample file provided with the package
database_file <- file.path(system.file("testdata", package = "massFlowR"), "DBtemplate.csv")

## build a database template object
database <- buildDB(file = database_file)

## check what the database template consists of
chemicals(database)

## check how database table looks using slot "db"
database@db
```

Once `massFlowDB` object is built, peak alignment can be initiated via `buildTMP`function,  using `massFlowDB` object as one of the inputs.

```{r massFlowTemplate_with_db}
## initiate template using the chemical reference database and first sample in the study
template <- buildTMP(file = file.path(out_directory, "experiment.csv"), mz_err = 0.01, rt_err = 10, db = database)
```

```{r alignPEAKS_with_db, eval = FALSE}
## align peaks across all remaining samples
template <- alignPEAKS(template)
```

# Alignment validation

*(under development)*

Once peaks are aligned across all samples, the obtained PCSs are validated. Intensity values for each peak in a group are correlated across all samples. Correlation estimates are then used to build networks of peaks, that behave similarly across all samples. Peaks exhibiting a different pattern in their intensities are put into a new PCS.

Finally, for samples, in which a peak from a validated PCS was not detected, peak-filling is performed. Intensity data is obtained for each missing peak using original LC-MS files. In contrast to `xcms` package, *m/z* and *rt* values for intensity integration are estimated for each sample separetely. *m/z* and *rt* values are taken from two surrounding samples, in which the peak-of-interest was present, and extrapolated. 

# See also

* [Automatic peak annotation](http://htmlpreview.github.io/?https://github.com/lauzikaite/massFlowR/blob/master/inst/doc/annotation.html)
